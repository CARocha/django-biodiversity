{% extends "base.html" %}
{%block extra_header%}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<!--<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/src/markerclusterer.js"></script>-->
<!--<script type="text/javascript" src="/files/js/markerclusterer.js"></script>-->
<script type="text/javascript" src="/files/js/infobox.js"></script>
<script type="text/javascript">    
    // Aplicar QuickSearch a la tabla y la lista
    var map;
    var ibs = new Array();    
    $(document).ready(function () {        
        var myLatlng = new google.maps.LatLng(-0.175781,-78.398437);
        var myOptions = {
            zoom: 4,
            mapTypeControl: true,
            center: myLatlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }        
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        
        var image = new google.maps.MarkerImage('/files/img/custom_marker.png',
        new google.maps.Size(45, 44),
        new google.maps.Point(0,0),
        new google.maps.Point(0, 32));

        $.getJSON('/bioversity/ajax/zonas/', function(data){
            $.each(data, function(i, elemento){                
                var latlng = new google.maps.LatLng(elemento.punto[0], elemento.punto[1]);
                var marker = new google.maps.Marker({
                    position: latlng,
                    map: map,
                    title: elemento.zona,
                    icon: image,
                    id: elemento.id
                });
                attachInfowindow(marker, elemento.socios);
            });
        });        
    });
    
    function attachInfowindow(marker, socios) {
        var ib;
        var salida;
        var text = document.createElement("div");
        text.style.cssText = "border: 1px solid #92B900; background:#fff; padding: 5px; overflow: auto;";
        salida = "<div class='infobox'><ul>";
        for(var i=0; i < socios.length; i++){            
            salida += "<li><a href='/bioversity/ficha/"+socios[i].id+"'>"+socios[i].nombre+"</a></li>";
        }
        salida += "</ul></div>";                

        text.innerHTML = salida;
        var myOptions = {            
            content: text,
            disableAutoPan: false,
            maxWidth: 0,
            pixelOffset: new google.maps.Size(-130, 0),
            zIndex: null,
            boxStyle: {
                background: "url('../images/tipbox.gif') no-repeat",
                opacity: 1,
                width: "180px"
            },
            closeBoxMargin: "2px 5px 0px 2px",
            closeBoxURL: "http://www.google.com/intl/en_us/mapfiles/close.gif",
            infoBoxClearance: new google.maps.Size(1, 1),
            isHidden: false,
            pane: "floatPane",
            enableEventPropagation: false
        };       
        
        ib = new InfoBox(myOptions);
        ibs.push(ib);        
        google.maps.event.addListener(marker, 'mouseover', function() {
            try{
                for(var i=0;i<ibs.length;i++){
                    ibs[i].close();
                }                
            }catch(err){}
            ib.open(map, marker);
        });
    }           
</script>
<style type="text/css">
    #map_canvas{        
        height: 450px;
    }
</style>
{%endblock%}

{% block contenido %}
<div class="clean"></div>
<br>
<div id="encabezado_contenido">Mapa de ubicaci√≥n de socios y zonas de control <a href="/bioversity/socios/">Socios</a> </div>
<div id="map_canvas"></div>
<div id="lista-actores">
    <table>
        <tr class="fondo-azul">
            <th>Socio </th>
            <th>Zona</th>
            <th>Pais</th>
        </tr>
        {% for socio in socios.object_list %}
            {% for zona in socio.zona.all%}
            <tr  class="actores" onclick="window.location='/bioversity/ficha/{{socio.id}}' ">
                {%if forloop.first%}
                <td  class="actores" colspan="1" rowspan="{{socio.zona.all.count}}"><b>{{socio.nombre}}</b></td>
                {%else%}
                
                {%endif%}
                <td class="actores">
                {{zona.nombre}} 
                </td>
                <td class="actores">
                 {{zona.pais.nombre}}
                 </td>
            </tr>
            {%endfor%}        
     
        {%endfor%}
        
    </table>
</div>
<div class="clean"></div>
{% endblock %}
