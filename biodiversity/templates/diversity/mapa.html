{% extends "base.html" %}
{%block extra_header%}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<!--<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/src/markerclusterer.js"></script>-->
<script type="text/javascript" src="/files/js/markerclusterer.js"></script>
<script type="text/javascript" src="/files/js/infobox.js"></script>
<script type="text/javascript">    
    // Aplicar QuickSearch a la tabla y la lista
    var map;
    var markers = [];
    $(document).ready(function () {
        var myLatlng = new google.maps.LatLng({{center.lat}}, {{center.lon}});
        var myOptions = {
            zoom: 2,
            mapTypeControl: false,
            center: myLatlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        
        var image = new google.maps.MarkerImage('/files/img/custom_marker.png',
        new google.maps.Size(15, 32),
        new google.maps.Point(0,0),
        new google.maps.Point(0, 32));

        $.getJSON('/bioversity/ajax/zonas/', function(data){
            $.each(data, function(i, elemento){
                var latlng = new google.maps.LatLng(elemento.latitud, elemento.longitud);
                var marker = new google.maps.Marker({
                    position: latlng,
                    map: map,
                    title: elemento.nombre,
                    icon: image,
                    id: elemento.id
                });
                attachInfowindow(marker, elemento.id);
                markers.push(marker);
            });
        });
    });

    var ib;
    function attachInfowindow(marker, id) {
        var boxText = document.createElement("div");
        boxText.innerHTML = '';
        boxText.style.cssText = "border: 1px solid #92B900; background:#fff; padding: 5px; overflow: auto;";
        var html_cajita = '';
        $.getJSON('/bioversity/ajax/socios/' + id, function(data){
          html_cajita =  "<div class='infobox'><ul>"; 
            $.each(data, function(i, socio){
              html_cajita += "<li><a href='/bioversity/socio/" + socio.id + "/'>"+socio.nombre+"</a></li>";
              });
            html_cajita += "</ul></div>";
          });


        alert(html_cajita); 
        boxText.innerHTML = html_cajita;
        alert(boxText.innerHTML);
        var myOptions = {
            content: boxText,
            disableAutoPan: false,
            maxWidth: 0,
            pixelOffset: new google.maps.Size(-130, 0),
            zIndex: null,
            boxStyle: {
                background: "url('../images/tipbox.gif') no-repeat",
                opacity: 1,
                width: "180px"
            },
            closeBoxMargin: "2px 5px 0px 2px",
            closeBoxURL: "http://www.google.com/intl/en_us/mapfiles/close.gif",
            infoBoxClearance: new google.maps.Size(1, 1),
            isHidden: false,
            pane: "floatPane",
            enableEventPropagation: false
        };
        alert(boxText.innerHTML);


        ib = new InfoBox(myOptions);
        google.maps.event.addListener(marker, 'mouseover', function() {
            try{
                infowindow.close();
            }catch(err){}
            ib.open(map, marker);
        });
    }
function deepCopy(obj) {
    if (Object.prototype.toString.call(obj) === '[object Array]') {
        var out = [], i = 0, len = obj.length;
        for ( ; i < len; i++ ) {
            out[i] = arguments.callee(obj[i]);
        }
        return out;
    }
    if (typeof obj === 'object') {
        var out = {}, i;
        for ( i in obj ) {
            out[i] = arguments.callee(obj[i]);
        }
        return out;
    }
    return obj;
}
                
</script>
<style type="text/css">
    #map_canvas{        
        height: 500px;
}
</style>
{%endblock%}

{% block contenido %}
<div class="clean"></div>
<div id="map_canvas"></div>
{% endblock %}
